---
title: "COVID-19 Data"
author: "Brian Gulbis, PharmD, BCPS"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
    html_document:
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(lubridate)
library(themebg)
```

```{r}
data_dir <- "csse_covid_19_data/csse_covid_19_daily_reports"

# f <- list.files(data_dir, pattern = "csv", full.names = TRUE)

# x <- map(f, read_csv)
# raw_daily <- map_df(f, read_csv)
# day1 <- read_csv("csse_covid_19_data/csse_covid_19_daily_reports/01-22-2020.csv")
# yest <- read_csv("csse_covid_19_data/csse_covid_19_daily_reports/03-22-2020.csv")
curr <- read_csv("csse_covid_19_data/csse_covid_19_daily_reports/03-24-2020.csv")
```

```{r}
df_confirmed <- read_csv("csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv") %>%
    rename(
        state = `Province/State`,
        country = `Country/Region`,
        lat = Lat,
        long = Long
    ) %>%
    pivot_longer(
        cols = c(-state, -country, -lat, -long), 
        names_to = "date", 
        values_to = "confirmed"
    ) %>%
    mutate_at("date", as_date, format = "%m/%d/%y", tz = "UTC")

df_deaths <- read_csv("csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv") %>%
    rename(
        state = `Province/State`,
        country = `Country/Region`,
        lat = Lat,
        long = Long
    ) %>%
    pivot_longer(
        cols = c(-state, -country, -lat, -long), 
        names_to = "date", 
        values_to = "deaths"
    ) %>%
    mutate_at("date", as_date, format = "%m/%d/%y", tz = "UTC")

df_recovered <- read_csv("csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv") %>%
    rename(
        state = `Province/State`,
        country = `Country/Region`,
        lat = Lat,
        long = Long
    ) %>%
    pivot_longer(
        cols = c(-state, -country, -lat, -long), 
        names_to = "date", 
        values_to = "recovered"
    ) %>%
    mutate_at("date", as_date, format = "%m/%d/%y", tz = "UTC")

df_ts <- left_join(df_confirmed, df_deaths) %>%
    left_join(df_recovered)
```

```{r}
df_country <- df_ts %>%
    group_by(country, date) %>%
    summarize_at(c("confirmed", "deaths", "recovered"), sum, na.rm = TRUE) %>%
    ungroup() %>%
    mutate(active = confirmed - deaths - recovered) %>%
    group_by(country) %>%
    mutate(new_cases = confirmed - lag(confirmed))

df_case1 <- df_country %>%
    group_by(country) %>%
    arrange(date, country) %>%
    filter(confirmed > 0) %>%
    distinct(country, .keep_all = TRUE) %>%
    select(country, date_case1 = date)

df_case50 <- df_country %>%
    group_by(country) %>%
    arrange(date, country) %>%
    filter(confirmed > 50) %>%
    distinct(country, .keep_all = TRUE) %>%
    select(country, date_case50 = date)
    
df_data <- df_country %>%
    left_join(df_case1) %>%
    left_join(df_case50) %>%
    mutate(
        day_case1 = difftime(date, date_case1, units = "days"),
        day_case50 = difftime(date, date_case50, units = "days"),
        usa = country == "US"
    ) %>%
    mutate_at(c("day_case1", "day_case50"), as.numeric)
```

```{r}
df_data %>%
    filter(day_case1 >= 0) %>%
    ggplot(aes(x = day_case1, y = confirmed, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case1 >= 0) %>%
    ggplot(aes(x = day_case1, y = deaths, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case1 >= 0) %>%
    ggplot(aes(x = day_case1, y = recovered, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case1 >= 0) %>%
    ggplot(aes(x = day_case1, y = active, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case1 >= 0) %>%
    ggplot(aes(x = day_case1, y = new_cases, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case50 >= 0) %>%
    ggplot(aes(x = day_case50, y = confirmed, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case50 >= 0) %>%
    ggplot(aes(x = day_case50, y = deaths, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case50 >= 0) %>%
    ggplot(aes(x = day_case50, y = recovered, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case50 >= 0) %>%
    ggplot(aes(x = day_case50, y = active, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

```{r}
df_data %>%
    filter(day_case50 >= 0) %>%
    ggplot(aes(x = day_case50, y = new_cases, color = country, size = usa)) +
    geom_line() +
    scale_size_discrete(NULL, range = c(0, 1.5)) +
    theme_bg() +
    theme(legend.position = "none")
```

